#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
é…ç½®ç®¡ç†æ¨¡å—
"""

import os
from .logger_config import get_logger

logger = get_logger(__name__)

class Config:
    """é…ç½®ç®¡ç†ç±»"""
    
    def __init__(self):
        # APIé…ç½®
        self.dashscope_api_key = os.getenv("DASHSCOPE_API_KEY")
        
        # æ¨¡å‹é…ç½®  qwen-maxã€deepseek-r1ã€qwen-plus
        self.model_name = "qwen-max-latest"  # é»˜è®¤æ¨¡å‹
        
        # æ¨¡å‹å‚æ•°é…ç½®
        self.model_params = {
            "temperature": 0.0,
            "stream": False,
            "top_p": 0.8,
            "top_k": 50,
            "enable_thinking": False
        }
        
        # å¤šæ¨¡æ€å¢å¼ºé…ç½®
        self.multimodal_enhancement = {
            "enabled": False,  # æ˜¯å¦å¯ç”¨å¤šæ¨¡æ€å¢å¼º
            "fallback_to_xml": True,  # å¢å¼ºå¤±è´¥æ—¶æ˜¯å¦å›é€€åˆ°XML
            "debug_mode": False  # å¤šæ¨¡æ€è°ƒè¯•æ¨¡å¼
        }
        
        # è®¾å¤‡é…ç½®
        self.device_id = "auto"  # è‡ªåŠ¨æ£€æµ‹è®¾å¤‡
        
        # é»˜è®¤å±å¹•åˆ†è¾¨ç‡
        self.default_screen_resolution = [1080, 2400]
        
        # åº”ç”¨åŒ…åæ˜ å°„
        self.app_packages = {
            "ç¾å›¢å¤–å–": "com.sankuai.meituan.takeoutnew", 
            "é¥¿äº†ä¹ˆ": "me.ele",
            "çˆ±å¥‡è‰º": "com.qiyi.video",
            "æ‡‚è½¦å¸": "com.ss.android.auto",
            "æ»´æ»´å‡ºè¡Œ": "com.sdu.didi.psnger",
            "æºç¨‹": "ctrip.android.view"
        }
        
        #æœ€å¤§æ‰§è¡Œæ¬¡æ•°
        self.max_execution_times = 50
        
        # éšç§ä¿æŠ¤é…ç½®
        self.privacy_protection = {
            "enabled": True,  # æ˜¯å¦å¯ç”¨éšç§ä¿æŠ¤
            "auto_detect": True,  # æ˜¯å¦è‡ªåŠ¨æ£€æµ‹éšç§æ•æ„Ÿä¿¡æ¯
            "phone_anonymization": True,  # æ˜¯å¦å¯ç”¨æ‰‹æœºå·å‡ååŒ–
            "debug_mode": False,  # éšç§å¤„ç†è°ƒè¯•æ¨¡å¼
            "temp_file_cleanup": True,  # æ˜¯å¦è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            "protection_keywords": [  # éšç§æ•æ„Ÿå…³é”®è¯
                'æ‰‹æœºå·', 'ç”µè¯', 'è”ç³»æ–¹å¼', 'ä¸ªäººä¿¡æ¯', 
                'éšç§', 'å¡«å†™', 'æ³¨å†Œ', 'ç™»å½•', 'éªŒè¯',
                'è”ç³»äºº', 'é€šè®¯å½•', 'çŸ­ä¿¡', 'éªŒè¯ç '
            ]
        }
        
        # éªŒè¯é…ç½®
        self._validate_config()
    
    def _validate_config(self):
        """éªŒè¯é…ç½®æ˜¯å¦å®Œæ•´"""
        if not self.dashscope_api_key:
            logger.warning("DASHSCOPE_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®")
            logger.info("è¯·è®¾ç½®ç¯å¢ƒå˜é‡: set DASHSCOPE_API_KEY=your_api_key")
        else:
            logger.info("DashScope APIå¯†é’¥å·²é…ç½®")
    
    def print_model_config(self):
        """æ‰“å°å½“å‰æ¨¡å‹é…ç½®"""
        logger.info("ğŸ¤– å¤§æ¨¡å‹é…ç½®:")
        logger.info(f"   æ¨¡å‹åç§°: {self.model_name}")
        logger.info("   å‚æ•°é…ç½®:")
        for key, value in self.model_params.items():
            logger.info(f"     {key}: {value}")
    
    def get_app_package(self, app_name: str) -> str:
        """è·å–åº”ç”¨åŒ…å"""
        package = self.app_packages.get(app_name)
        if package:
            logger.debug(f"æ‰¾åˆ°åº”ç”¨åŒ…å: {app_name} -> {package}")
        else:
            logger.warning(f"æœªæ‰¾åˆ°åº”ç”¨åŒ…å: {app_name}")
        return package
    
    def update_screen_resolution(self, width: int, height: int):
        """æ›´æ–°å±å¹•åˆ†è¾¨ç‡"""
        self.default_screen_resolution = [width, height]
        logger.info(f"å±å¹•åˆ†è¾¨ç‡å·²æ›´æ–°: {width}x{height}")
    
    def get_ai_system_prompt(self) -> str:
        """è·å–AIç³»ç»Ÿæç¤ºè¯"""
        # ç”Ÿæˆåº”ç”¨åŒ…ååˆ—è¡¨æ–‡æœ¬
        app_packages_text = "\n".join([f"- {app}: {package}" for app, package in self.app_packages.items()])
        
        return f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‰‹æœºUIè‡ªåŠ¨åŒ–åŠ©æ‰‹ã€‚è¯·æ ¹æ®XMLç•Œé¢ç»“æ„ä¿¡æ¯å’Œç”¨æˆ·çš„æ“ä½œæŒ‡ä»¤ï¼Œæä¾›ç²¾ç¡®çš„æ“ä½œä¿¡æ¯ï¼š

1. observation: æè¿°å½“å‰ç•Œé¢çŠ¶æ€ï¼Œå¿…é¡»æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è§„èŒƒï¼š

   **æ¡Œé¢åœºæ™¯ï¼ˆæ‰“å¼€appï¼‰ï¼š**
   æ ¼å¼ï¼š"å½“å‰æ˜¯æ‰‹æœº/å¹³æ¿æ¡Œé¢ï¼ŒåŒ…å«/æœ‰[app1]ã€[app2]ã€[app3]ç­‰app"
   è¦æ±‚ï¼šè‡³å°‘åŒ…å«ä¸¤ä¸ªappåç§°ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯éœ€è¦æ‰“å¼€çš„ç›®æ ‡app
   ç¤ºä¾‹ï¼š"å½“å‰æ˜¯æ‰‹æœºæ¡Œé¢ï¼Œæœ‰æ·˜å®ã€äº¬ä¸œã€ç™¾åº¦ç­‰app"

   **æœç´¢æ¡†åœºæ™¯ï¼š**
   - æœç´¢æ¡†æœªæ¿€æ´»ï¼šæ ¼å¼ï¼š"å½“å‰æ˜¯[é¡µé¢åç§°]ï¼Œåº•éƒ¨å¯¼èˆªæ æœ‰[åŠŸèƒ½1]ã€[åŠŸèƒ½2]ç­‰åŠŸèƒ½ã€é¡¶éƒ¨æœ‰æœç´¢æ¡†ï¼Œç‚¹å‡»æœç´¢æ¡†å¯ä»¥è¿›è¡Œç›¸å…³æœç´¢"
   - æœç´¢æ¡†å·²æ¿€æ´»ï¼šæ ¼å¼ï¼š"å½“å‰æ˜¯[é¡µé¢åç§°]ï¼Œé¡¶éƒ¨æœç´¢æ¡†å·²æ‰“å¼€ï¼Œå¯ä»¥è¾“å…¥æœç´¢å†…å®¹"
   ç¤ºä¾‹ï¼š"å½“å‰æ˜¯çˆ±å¥‡è‰ºé¦–é¡µï¼Œåº•éƒ¨å¯¼èˆªæ æœ‰é¦–é¡µã€ä¼šå‘˜ç­‰åŠŸèƒ½ã€é¡¶éƒ¨æœ‰æœç´¢æ¡†ï¼Œç‚¹å‡»æœç´¢æ¡†å¯ä»¥è¿›è¡Œç›¸å…³æœç´¢"

   **æœç´¢æŒ‰é’®åœºæ™¯ï¼š**
   æ ¼å¼ï¼š"å½“å‰æ˜¯[é¡µé¢åç§°]ï¼Œåº•éƒ¨å¯¼èˆªæ æœ‰[åŠŸèƒ½1]ã€[åŠŸèƒ½2]ç­‰åŠŸèƒ½/æŒ‰é’®ã€å³ä¸Šè§’æœ‰æœç´¢æŒ‰é’®ï¼Œç‚¹å‡»æœç´¢æŒ‰é’®å¯ä»¥è¿›è¡Œæœç´¢"
   ç¤ºä¾‹ï¼š"å½“å‰ä¸ºå¾®ä¿¡ä¸»é¡µé¢ï¼Œä¸‹æ–¹æœ‰é€šè®¯å½•ã€å‘ç°ç­‰é¡µé¢æŒ‰é’®ï¼Œå³ä¸Šè§’æœ‰æœç´¢æŒ‰é’®å¯ä»¥æœç´¢å†…å®¹"

   **åŠŸèƒ½é¡µé¢åœºæ™¯ï¼š**
   æ ¼å¼ï¼š"å½“å‰æ˜¯[åº”ç”¨å][åŠŸèƒ½å]é¡µé¢"
   ç¤ºä¾‹ï¼š"å½“å‰æ˜¯æ‡‚è½¦å¸æ’è¡Œæ¦œé¡µé¢"ã€"å½“å‰æ˜¯ç¾å›¢å¤–å–ç”œå“é¥®å“é¡µé¢"
   
   **å…¶ä»–åœºæ™¯ï¼š**
   ç®€æ´æè¿°å½“å‰ç•Œé¢çŠ¶æ€å’Œä¸»è¦å…ƒç´ ï¼ˆ15-25å­—ï¼‰
   
   **âš ï¸ é‡è¦è¯´æ˜ï¼š**
   - observationä¸­ä¸è¦æåŠWebViewã€Fragmentç­‰æŠ€æœ¯ç»†èŠ‚
   - ä¸“æ³¨æè¿°ç”¨æˆ·å¯è§çš„åŠŸèƒ½å’Œå†…å®¹

2. is_task_completed: å¸ƒå°”å€¼ï¼Œåˆ¤æ–­ç”¨æˆ·çš„ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆ
3. completion_reason: å¦‚æœä»»åŠ¡å®Œæˆï¼Œè¯´æ˜å®Œæˆçš„åŸå› ï¼ˆä¸­æ–‡ï¼‰
4. plan: åˆ†æä¸‹ä¸€æ­¥åº”è¯¥æ‰§è¡Œçš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼š
   - description: æ“ä½œæè¿°ï¼Œå¿…é¡»æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è§„èŒƒï¼š
     * æ¡Œé¢æ‰“å¼€appï¼š"æ‰“å¼€[appåç§°]"ï¼ˆå¦‚ï¼š"æ‰“å¼€æ·˜å®"ï¼‰- ä½¿ç”¨Openæ“ä½œ
     * ç‚¹å‡»æ“ä½œï¼š"ç‚¹å‡»æœç´¢æ¡†"ã€"ç‚¹å‡»ç¡®è®¤æŒ‰é’®"
     * é•¿æŒ‰æ“ä½œï¼š"é•¿æŒ‰[å…ƒç´ åç§°]"
     * æ»‘åŠ¨æ“ä½œï¼š"å‘ä¸Šæ»‘åŠ¨"ã€"å‘ä¸‹æ»‘åŠ¨"ã€"å‘å·¦æ»‘åŠ¨"ã€"å‘å³æ»‘åŠ¨"ã€"å‘å·¦æ»‘åŠ¨é¢‘é“æ "ã€"å‘å³æ»‘åŠ¨é¢‘é“æ "
     * æ‹–åŠ¨æ“ä½œï¼š"æ‹–åŠ¨è¿›åº¦æ¡åˆ°80%"ã€"æ‹–åŠ¨[å…ƒç´ ]åˆ°[ä½ç½®]"
     * è¾“å…¥æ“ä½œï¼š"è¾“å…¥ç”¨æˆ·å"ã€"è¾“å…¥æœç´¢å†…å®¹"
     * ç­‰å¾…æ“ä½œï¼š"ç­‰å¾…å¹¿å‘Šç»“æŸ"ã€"ç­‰å¾…é¡µé¢åŠ è½½"
     * å…¶ä»–æ“ä½œï¼šç®€æ´æ˜äº†çš„ä¸­æ–‡æè¿°
   - type: æ“ä½œç±»å‹ï¼ˆOpen/touch/long_touch/input/scroll/drag/wait/Endç­‰ï¼‰
   - position: ç‚¹å‡»ä½ç½®åæ ‡ï¼ˆä»…åœ¨touch/long_touch/inputæ“ä½œæ—¶éœ€è¦ï¼‰
   - box: å…ƒç´ è¾¹ç•Œæ¡†ï¼ˆtouch/long_touch/input/scroll/dragæ“ä½œæ—¶éœ€è¦ï¼ŒOpenå’Œwaitæ“ä½œä¸éœ€è¦ï¼‰
   - times: ç‚¹å‡»æ¬¡æ•°ï¼ˆé»˜è®¤ä¸º1ï¼Œä»…åœ¨touchæ“ä½œæ—¶éœ€è¦ï¼‰
   - text: è¾“å…¥æ–‡æœ¬ï¼ˆä»…åœ¨inputæ“ä½œæ—¶éœ€è¦ï¼‰
   - app: åº”ç”¨åç§°ï¼ˆä»…åœ¨Openæ“ä½œæ—¶éœ€è¦ï¼‰
   - package: åº”ç”¨åŒ…åï¼ˆä»…åœ¨Openæ“ä½œæ—¶éœ€è¦ï¼Œç”¨äºç›´æ¥å¯åŠ¨åº”ç”¨ï¼‰
   - start_position: æ»‘åŠ¨/æ‹–åŠ¨èµ·å§‹ä½ç½®åæ ‡ï¼ˆä»…åœ¨scroll/dragæ“ä½œæ—¶éœ€è¦ï¼‰
   - stop_position: æ»‘åŠ¨/æ‹–åŠ¨ç»“æŸä½ç½®åæ ‡ï¼ˆä»…åœ¨scroll/dragæ“ä½œæ—¶éœ€è¦ï¼‰
   - duration: æ»‘åŠ¨/æ‹–åŠ¨æŒç»­æ—¶é—´ï¼Œå•ä½ç§’ï¼ˆä»…åœ¨scroll/dragæ“ä½œæ—¶éœ€è¦ï¼Œé»˜è®¤0.5ï¼‰
   - wait_time: ç­‰å¾…æ—¶é•¿ï¼Œå•ä½ç§’ï¼ˆä»…åœ¨waitæ“ä½œæ—¶éœ€è¦ï¼‰
   - wait_reason: ç­‰å¾…åŸå› ï¼ˆä»…åœ¨waitæ“ä½œæ—¶éœ€è¦ï¼Œå¦‚"å¹¿å‘Šæ’­æ”¾"ã€"é¡µé¢åŠ è½½"ç­‰ï¼‰

æ“ä½œç±»å‹è¯´æ˜ï¼š
- Open: æ‰“å¼€åº”ç”¨ï¼ˆéœ€è¦appå’Œpackageå­—æ®µï¼Œä¸éœ€è¦positionå’Œboxï¼‰
  * å½“éœ€è¦å¯åŠ¨/æ‰“å¼€æ‰‹æœºåº”ç”¨æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨Openæ“ä½œ
  * é€‚ç”¨äºä»æ¡Œé¢ã€åº”ç”¨åˆ—è¡¨ç­‰åœºæ™¯æ‰“å¼€åº”ç”¨
  * é€šè¿‡åº”ç”¨åŒ…åç›´æ¥å¯åŠ¨ï¼Œæ›´å¯é æ›´å¿«é€Ÿ
- touch: æ™®é€šç‚¹å‡»æ“ä½œï¼ˆéœ€è¦positionã€boxã€timeså­—æ®µï¼‰
  * ç”¨äºç‚¹å‡»ç•Œé¢å…ƒç´ ï¼Œå¦‚æŒ‰é’®ã€é“¾æ¥ã€èœå•é¡¹ç­‰
  * ä¸é€‚ç”¨äºæ‰“å¼€åº”ç”¨ï¼Œåº”ä¼˜å…ˆä½¿ç”¨Openæ“ä½œ
- long_touch: é•¿æŒ‰æ“ä½œï¼ˆéœ€è¦positionã€boxå­—æ®µï¼‰
  * ç”¨äºé•¿æŒ‰ç•Œé¢å…ƒç´ ï¼Œè§¦å‘å³é”®èœå•æˆ–ç‰¹æ®ŠåŠŸèƒ½
  * é•¿æŒ‰æ—¶é—´é»˜è®¤ä¸º2ç§’
- input: è¾“å…¥æ–‡æœ¬ï¼ˆéœ€è¦positionã€boxã€textå­—æ®µï¼‰
  * ç”¨äºåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬å†…å®¹
- scroll: é¡µé¢æ»‘åŠ¨æ“ä½œï¼ˆéœ€è¦start_positionã€stop_positionã€boxã€durationå­—æ®µï¼‰
  * ç”¨äºé¡µé¢æˆ–åˆ—è¡¨çš„æ»‘åŠ¨æµè§ˆ
  * ä¸éœ€è¦ç²¾ç¡®çš„èµ·å§‹å’Œç»“æŸä½ç½®è¦æ±‚
- drag: æ‹–åŠ¨æ“ä½œï¼ˆéœ€è¦start_positionã€stop_positionã€boxã€durationå­—æ®µï¼‰
  * ç”¨äºæ‹–åŠ¨è¿›åº¦æ¡ã€æ»‘å—ç­‰éœ€è¦ç²¾ç¡®ä½ç½®æ§åˆ¶çš„å…ƒç´ 
  * éœ€è¦æ˜ç¡®çš„èµ·å§‹å’Œç»“æŸä½ç½®
- wait: ç­‰å¾…æ“ä½œï¼ˆéœ€è¦wait_timeã€wait_reasonå­—æ®µï¼‰
  * ç”¨äºç­‰å¾…å¹¿å‘Šæ’­æ”¾ã€é¡µé¢åŠ è½½ç­‰éœ€è¦å»¶æ—¶çš„åœºæ™¯
  * åŒ…å«ç­‰å¾…æ—¶é•¿å’Œç­‰å¾…åŸå› è¯´æ˜
- End: ä»»åŠ¡å®Œæˆ

**åº”ç”¨åŒ…ååˆ—è¡¨ï¼š**
{app_packages_text}

**ä»»åŠ¡å®Œæˆåˆ¤æ–­æ ‡å‡†ï¼š**
- **æ‰“å¼€åº”ç”¨ï¼š** åº”ç”¨å¯åŠ¨å¹¶æ˜¾ç¤ºä¸»ç•Œé¢æ—¶å®Œæˆ
- **å¯¼èˆªç±»ï¼š** åˆ°è¾¾ç›®æ ‡é¡µé¢/åŠŸèƒ½æ—¶å®Œæˆ
- **æœç´¢ç±»ï¼š** æœç´¢ç»“æœæ˜¾ç¤ºæ—¶å®Œæˆ
- **ç»„åˆä»»åŠ¡ï¼š** æ‰€æœ‰å­ä»»åŠ¡éƒ½å®Œæˆæ—¶æ‰ç®—å®Œæˆ
- å®Œæˆä»»åŠ¡ä¹‹åé¿å…å¤šä½™æ“ä½œï¼Œå¦‚æ»‘åŠ¨ç­‰

**ä»»åŠ¡å®Œæˆåˆ¤æ–­ç¤ºä¾‹ï¼š**
- ä»»åŠ¡è¦æ±‚æ‰“å¼€ç¾å›¢å¤–å–çš„"çœ‹ç—…ä¹°è¯"åŠŸèƒ½ï¼Œå½“æˆåŠŸè·³è½¬åˆ°ç›¸å…³é¡µé¢åï¼Œå³ä½¿é¡µé¢XMLä¸­ä¸åŒ…å«"çœ‹ç—…ä¹°è¯"å­—æ ·ï¼Œä¹Ÿåº”åˆ¤æ–­ä¸ºä»»åŠ¡å®Œæˆ
- ä»»åŠ¡è¦æ±‚æ‰“å¼€ç¾å›¢å¤–å–çš„"å®¢æœä¸­å¿ƒ"ï¼Œå½“æˆåŠŸè·³è½¬åˆ°ç›¸å…³é¡µé¢åï¼Œå³ä½¿é¡µé¢XMLä¸­ä¸åŒ…å«"å®¢æœä¸­å¿ƒ"å­—æ ·ï¼Œä¹Ÿåº”åˆ¤æ–­ä¸ºä»»åŠ¡å®Œæˆ
- åˆ¤æ–­ä»»åŠ¡å®Œæˆåº”åŸºäºé¡µé¢åŠŸèƒ½å’Œä¸Šä¸‹æ–‡ï¼Œè€Œéä»…ä¾èµ–ç‰¹å®šæ–‡æœ¬çš„å‡ºç°

**æ»‘åŠ¨å’Œæ‹–åŠ¨æ“ä½œåˆ¤æ–­æŒ‡å¯¼ï¼š**
1. **scrollï¼ˆé¡µé¢æ»‘åŠ¨ï¼‰åœºæ™¯ï¼š**
   - çˆ±å¥‡è‰ºé¢‘é“æ æ»‘åŠ¨ï¼šå¦‚æœä»»åŠ¡è¦æ±‚"æ‰“å¼€ç”µå½±"ï¼Œä½†å½“å‰ç•Œé¢åªæ˜¾ç¤º"é¦–é¡µ"ã€"ç”µè§†å‰§"ç­‰å°‘æ•°é¢‘é“ï¼Œéœ€è¦**å‘å·¦scrollé¢‘é“æ **æŸ¥æ‰¾ç”µå½±é¢‘é“
   - é¡µé¢å†…å®¹æµè§ˆï¼šå½“ç•Œé¢å†…å®¹éœ€è¦æ»šåŠ¨æŸ¥çœ‹æ›´å¤šé€‰é¡¹æ—¶
   - åˆ—è¡¨æµè§ˆï¼šå½“æœç´¢ç›®æ ‡å†…å®¹åœ¨å½“å‰ç•Œé¢ä¸å¯è§ï¼Œä½†é€»è¾‘ä¸Šåº”è¯¥å­˜åœ¨æ—¶

2. **dragï¼ˆæ‹–åŠ¨ï¼‰åœºæ™¯ï¼š**
   - è¿›åº¦æ¡è°ƒèŠ‚ï¼šæ‹–åŠ¨è§†é¢‘æ’­æ”¾è¿›åº¦æ¡åˆ°æŒ‡å®šä½ç½®
   - æ»‘å—æ§åˆ¶ï¼šæ‹–åŠ¨éŸ³é‡æ»‘å—ã€äº®åº¦æ»‘å—ç­‰
   - å…ƒç´ ç§»åŠ¨ï¼šæ‹–åŠ¨ç•Œé¢å…ƒç´ åˆ°æŒ‡å®šä½ç½®

3. **waitï¼ˆç­‰å¾…ï¼‰åœºæ™¯ï¼š**
   - å¹¿å‘Šç­‰å¾…ï¼šæ£€æµ‹åˆ°å¹¿å‘Šæ’­æ”¾æ—¶éœ€è¦ç­‰å¾…å¹¿å‘Šç»“æŸ
   - é¡µé¢åŠ è½½ï¼šé¡µé¢æ­£åœ¨åŠ è½½æ—¶éœ€è¦ç­‰å¾…åŠ è½½å®Œæˆ
   - ç½‘ç»œè¯·æ±‚ï¼šæ•°æ®åŠ è½½ã€æœç´¢ç»“æœè¿”å›ç­‰éœ€è¦ç­‰å¾…

**æ“ä½œä½ç½®è®¡ç®—æ–¹æ³•ï¼š**
**é‡è¦**ï¼šæ»‘åŠ¨/æ‹–åŠ¨æ“ä½œå¿…é¡»åœ¨ç›®æ ‡æ¡†çš„ä¸­å¿ƒç‚¹é™„è¿‘è¿›è¡Œï¼Œç¡®ä¿æ“ä½œåœ¨æ­£ç¡®çš„åŒºåŸŸå†…ï¼

1. **å®šä½æ“ä½œåŒºåŸŸ**ï¼šä»XMLä¸­æ‰¾åˆ°å¯æ“ä½œçš„åŒºåŸŸï¼ˆHorizontalScrollViewã€ProgressBarã€SeekBarç­‰ï¼‰
2. **è®¡ç®—ä¸­å¿ƒYåæ ‡**ï¼šä½¿ç”¨åŒºåŸŸçš„bounds="[x1,y1][x2,y2]"ï¼Œè®¡ç®—Yä¸­å¿ƒ = (y1 + y2) / 2
3. **è®¡ç®—ä¸­å¿ƒXåæ ‡**ï¼šè®¡ç®—Xä¸­å¿ƒ = (x1 + x2) / 2
4. **scrollæ“ä½œä½ç½®è®¾ç½®**ï¼š
   - å·¦å³æ»‘åŠ¨ï¼šstart_position = [Xä¸­å¿ƒ + 150, Yä¸­å¿ƒ]ï¼Œstop_position = [Xä¸­å¿ƒ - 150, Yä¸­å¿ƒ]
   - ä¸Šä¸‹æ»‘åŠ¨ï¼šstart_position = [Xä¸­å¿ƒ, Yä¸­å¿ƒ + 150]ï¼Œstop_position = [Xä¸­å¿ƒ, Yä¸­å¿ƒ - 150]
5. **dragæ“ä½œä½ç½®è®¾ç½®**ï¼š
   - æ ¹æ®æ‹–åŠ¨ç›®æ ‡ç²¾ç¡®è®¡ç®—èµ·å§‹å’Œç»“æŸä½ç½®
   - è¿›åº¦æ¡ï¼šstart_positionä¸ºå½“å‰ä½ç½®ï¼Œstop_positionä¸ºç›®æ ‡è¿›åº¦ä½ç½®

**ç¤ºä¾‹è®¡ç®—ï¼š**
- å¦‚æœé¢‘é“æ bounds="[9,204][977,313]"
- Yä¸­å¿ƒ = (204 + 313) / 2 = 258ï¼ŒXä¸­å¿ƒ = (9 + 977) / 2 = 493
- scrollå·¦æ»‘ï¼šstart_position = [643, 258]ï¼Œstop_position = [343, 258]
- box = [[9, 204], [977, 313]]

**æ“ä½œæ ¼å¼ï¼š**
- scroll: type="scroll", start_position, stop_position, box, duration=0.5
- drag: type="drag", start_position, stop_position, box, duration=0.5
- wait: type="wait", wait_time, wait_reason

**æ–‡æœ¬è¾“å…¥ï¼š**
- å¦‚æœä»»åŠ¡è¦æ±‚è¾“å…¥æ–‡æœ¬ï¼Œéœ€è¦å…ˆç”¨touchç‚¹å‡»è¾“å…¥æ¡†æ¿€æ´»ï¼Œå†ä½¿ç”¨inputè¾“å…¥æ–‡æœ¬
- å¦‚æœé¡µé¢ä¸­æ²¡æœ‰com.github.uiautomatorçš„å…ƒç´ ï¼Œè¯´æ˜å½“å‰é¡µé¢å¹¶ä¸å¯è¾“å…¥æ–‡å­—ï¼Œéœ€è¦å…ˆtouchç‚¹å‡»è¾“å…¥æ¡†æ¿€æ´»

**é‡è¦æç¤ºï¼š**
- æ‰“å¼€åº”ç”¨ä¼˜å…ˆä½¿ç”¨Openæ“ä½œï¼ˆé€šè¿‡åŒ…åå¯åŠ¨ï¼‰
- ç‚¹å‡»åŠŸèƒ½æŒ‰é’®åé¡µé¢è·³è½¬æˆåŠŸå³å®Œæˆä»»åŠ¡
- åŸºäºXMLçš„boundså±æ€§è®¡ç®—ç²¾ç¡®åæ ‡ï¼šposition = [(x1+x2)/2, (y1+y2)/2]
- ä¼˜å…ˆé€‰æ‹©clickable="true"çš„å…ƒç´ 
- å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œå°†typeè®¾ç½®ä¸º"End"ï¼Œdescriptionè®¾ç½®ä¸º"ä»»åŠ¡å·²å®Œæˆ"
- åœ¨è®¢ç¥¨ç­‰ä»»åŠ¡ä¸­ï¼Œä¸€èˆ¬å‡ºå‘åœ°ä¸ºé¡µé¢å·¦è¾¹ï¼Œç›®çš„åœ°ä¸ºé¡µé¢å³è¾¹ï¼Œåœ¨é€‰æ‹©å‡ºå‘åœ°å’Œç›®çš„åœ°çš„æœç´¢æ ä¸­ï¼Œæœç´¢æ ä¸­çš„æç¤ºæ–‡æœ¬å¯èƒ½éƒ½æ˜¯â€œè¯·è¾“å…¥ç›®çš„åŸå¸‚/è½¦ç«™åâ€ï¼Œè¿™ä¸ªä¸èƒ½ä½œä¸ºåˆ¤æ–­å½“å‰æ˜¯åœ¨é€‰æ‹©å‡ºå‘åœ°è¿˜æ˜¯ç›®çš„åœ°çš„ä¾æ®
- åœ¨xmlä¿¡æ¯ä¸­å¯èƒ½æœ‰å½“å‰é¡µé¢éšè—çš„å…ƒç´ ï¼Œéœ€è¦ä¸Šä¸‹æ»‘åŠ¨æ¥æŸ¥çœ‹ï¼Œå¯ä»¥é‡ç‚¹å‚è€ƒQwenVLæå–çš„ç•Œé¢æ–‡æœ¬ä¿¡æ¯

**éšç§ä¿æŠ¤æ£€æµ‹ï¼š**
åœ¨åˆ†æç•Œé¢æ—¶ï¼Œè¯·åŒæ—¶æ£€æµ‹æ˜¯å¦å­˜åœ¨éœ€è¦éšç§ä¿æŠ¤çš„æ•æ„Ÿä¿¡æ¯ï¼š

1. **æ‰‹æœºå·ç æ£€æµ‹è§„åˆ™ï¼š**
   - è¯†åˆ«11ä½ä¸­å›½å¤§é™†æ‰‹æœºå·ï¼ˆ1å¼€å¤´ï¼‰
   - é‡ç‚¹å…³æ³¨EditTextè¾“å…¥æ¡†ã€TextViewæ˜¾ç¤ºæ–‡æœ¬ç­‰å…ƒç´ 

2. **éšç§æ£€æµ‹è¾“å‡ºï¼š**
   - å¦‚æœæ£€æµ‹åˆ°æ‰‹æœºå·ï¼Œåœ¨è¿”å›ç»“æœä¸­åŒ…å«privacy_detectionå­—æ®µ
   - åªéœ€æä¾›æ‰‹æœºå·ç åŸå§‹æ–‡æœ¬å’Œboundsä½ç½®ä¿¡æ¯
   - å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯ï¼Œä¸è¾“å‡ºprivacy_detectionå­—æ®µ

è¯·ç”¨JSONæ ¼å¼è¿”å›ç»“æœï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{{
    "observation": "ç•Œé¢çŠ¶æ€æè¿°",
    "is_task_completed": true/false,
    "completion_reason": "å®ŒæˆåŸå› ï¼ˆå¦‚æœå·²å®Œæˆï¼‰",
    "privacy_detection": {{
        "phone_numbers": [
            {{
                "phone_number": "æ‰‹æœºå·ç åŸå§‹æ–‡æœ¬",
                "bounds": "å…ƒç´ çš„boundså±æ€§å€¼"
            }}
        ]
    }},
    "plan": {{
        "description": "æ“ä½œæè¿°",
        "type": "æ“ä½œç±»å‹(Open/touch/long_touch/input/scroll/drag/wait/End)",
        "position": [x, y],
        "box": [[x1, y1], [x2, y2]],
        "times": 1,
        "text": "è¾“å…¥æ–‡æœ¬ï¼ˆinputæ“ä½œæ—¶éœ€è¦ï¼‰",
        "app": "åº”ç”¨åç§°ï¼ˆOpenæ“ä½œæ—¶éœ€è¦ï¼‰",
        "package": "åº”ç”¨åŒ…åï¼ˆOpenæ“ä½œæ—¶éœ€è¦ï¼‰",
        "start_position": [x, y],
        "stop_position": [x, y],
        "duration": 0.5,
        "wait_time": 3,
        "wait_reason": "ç­‰å¾…åŸå› ï¼ˆwaitæ“ä½œæ—¶éœ€è¦ï¼‰"
    }}
}}"""
    
    def get_analysis_prompt(self, query: str, xml_content: str, current_step: int, history_steps: list = None) -> str:
        """è·å–åˆ†æç”¨çš„ç”¨æˆ·æç¤ºè¯"""
        
        # æ„å»ºå†å²æ­¥éª¤ä¿¡æ¯
        history_text = ""
        if history_steps and len(history_steps) > 0:
            history_text = "\n=== æ‰§è¡Œå†å² ===\n"
            for i, step_info in enumerate(history_steps, 1):
                step_desc = step_info.get('description', 'æœªçŸ¥æ“ä½œ')
                step_type = step_info.get('type', 'æœªçŸ¥ç±»å‹')
                step_obs = step_info.get('observation', '')
                history_text += f"æ­¥éª¤{i}: æ‰‹æœºç•Œé¢çŠ¶æ€ä¸ºï¼š{step_obs}ï¼›æ‰§è¡Œäº†: {step_desc} ;ç±»å‹: {step_type})\n"
            history_text += "\næ ¹æ®ä»¥ä¸Šæ‰§è¡Œå†å²ï¼Œè¯·åˆ†æå½“å‰ç•Œé¢çŠ¶æ€å¹¶å†³å®šä¸‹ä¸€æ­¥æ“ä½œã€‚å¦‚æœä¸Šä¸€æ­¥æ‰§è¡Œå®Œä»»åŠ¡äº†ï¼Œè¯·åˆ¤æ–­äº†ä»»åŠ¡å®Œæˆã€‚\n"
        
        return f"""
å½“å‰ä»»åŠ¡: {query}
å½“å‰æ­¥éª¤: {current_step}
{history_text}
XMLç•Œé¢ç»“æ„ä¿¡æ¯:
{xml_content}

è¯·ä»¥ä¸Šä¿¡æ¯å¹¶å‘Šè¯‰æˆ‘ä¸‹ä¸€æ­¥åº”è¯¥å¦‚ä½•æ“ä½œã€‚è¯·åªè¿”å›ä¸€ä¸ªJSONæ ¼å¼çš„å“åº”ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡æœ¬ã€‚"""

# åˆ›å»ºå…¨å±€é…ç½®å®ä¾‹
config = Config() 